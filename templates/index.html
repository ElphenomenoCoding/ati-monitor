<!DOCTYPE html>
<html lang="ru" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ATI –ú–æ–Ω–∏—Ç–æ—Ä –ì—Ä—É–∑–æ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Nunito', 'system-ui', 'sans-serif'] },
          colors: {
            brand: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81', 950: '#1e1b4b' },
            d: { 0: '#09090b', 1: '#18181b', 2: '#27272a', 3: '#3f3f46', 4: '#52525b', 5: '#71717a', 6: '#a1a1aa', 7: '#d4d4d8', 8: '#e4e4e7', 9: '#f4f4f5' },
          }
        }
      }
    }
  </script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    .feed-scroll {
      -webkit-overflow-scrolling: touch;
    }

    .touch-btn {
      min-height: 48px;
      min-width: 48px;
    }

    .pill-on {
      background: #4f46e5 !important;
      color: white !important;
      border-color: #4f46e5 !important;
    }

    .big-check {
      width: 22px;
      height: 22px;
      accent-color: #6366f1;
      cursor: pointer;
    }

    input[type="range"] {
      accent-color: #6366f1;
    }

    .glow-green {
      box-shadow: 0 0 0 2px #22c55e, 0 0 16px rgba(34, 197, 94, 0.2);
    }

    .toast-anim {
      animation: tup .25s ease;
    }

    @keyframes tup {
      from {
        transform: translateY(16px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .dd-shadow {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .mob-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    /* Welcome overlay */
    .welcome-bg {
      background: radial-gradient(ellipse at 50% 0%, #1e1b4b 0%, #09090b 70%);
    }

    /* Alarm tab mobile - horizontal scroll with snap */
    .alarm-scroll {
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .alarm-scroll>* {
      scroll-snap-align: start;
    }
  </style>
</head>

<body class="h-full bg-d-0 font-sans text-d-8 overflow-hidden">

  <!-- ============================================================= -->
  <!-- WELCOME / ONBOARDING OVERLAY                                   -->
  <!-- ============================================================= -->
  <div id="welcome-overlay" class="fixed inset-0 z-[100] welcome-bg flex items-center justify-center p-4">
    <div class="bg-d-1 border border-d-3 rounded-2xl p-6 md:p-10 max-w-lg w-full text-center shadow-2xl">
      <div class="text-5xl mb-4">üöõ</div>
      <h1 class="text-2xl md:text-3xl font-extrabold text-d-9 mb-2">ATI –ú–æ–Ω–∏—Ç–æ—Ä –ì—Ä—É–∑–æ–≤</h1>
      <p class="text-d-5 text-sm mb-6">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≥—Ä—É–∑–æ–≤ —Å ATI.SU<br>—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Telegram</p>

      <div class="bg-d-2 border border-d-3 rounded-xl p-5 text-left mb-6">
        <h3 class="font-bold text-d-8 text-sm mb-3">‚ö†Ô∏è –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã:</h3>
        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <span class="text-brand-400 font-bold text-lg leading-none mt-0.5">1</span>
            <div>
              <p class="text-d-7 text-sm font-semibold">–û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞:</p>
              <a href="https://t.me/atsusay_bot" target="_blank"
                class="inline-flex items-center gap-2 mt-1.5 bg-brand-950 border border-brand-700 text-brand-300 px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-900 transition">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.09l-1.77 8.35c-.13.6-.49.74-.99.46l-2.74-2.02-1.32 1.27c-.15.15-.27.27-.56.27l.2-2.79 5.07-4.58c.22-.2-.05-.3-.34-.12l-6.27 3.95-2.7-.84c-.59-.18-.6-.59.12-.87l10.56-4.07c.49-.18.91.12.74.99z" />
                </svg>
                @atsusay_bot
              </a>
            </div>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-brand-400 font-bold text-lg leading-none mt-0.5">2</span>
            <p class="text-d-7 text-sm font-semibold">–ù–∞–∂–º–∏—Ç–µ <span
                class="bg-brand-700 text-white px-2 py-0.5 rounded text-xs font-bold">START</span> –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <span
                class="bg-d-3 text-d-8 px-2 py-0.5 rounded text-xs font-mono">/start</span></p>
          </div>
          <div class="flex items-start gap-3">
            <span class="text-brand-400 font-bold text-lg leading-none mt-0.5">3</span>
            <p class="text-d-7 text-sm font-semibold">–í–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∏–∂–µ</p>
          </div>
        </div>
      </div>

      <label
        class="flex items-center justify-center gap-3 cursor-pointer select-none mb-5 p-3 rounded-xl border border-d-3 hover:border-brand-700 transition"
        id="welcome-check-label">
        <input type="checkbox" id="welcome-check" class="big-check rounded" onchange="checkWelcome()" />
        <span class="text-sm font-bold text-d-7">–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞) /start –±–æ—Ç—É @atsusay_bot</span>
      </label>

      <button id="welcome-btn" disabled onclick="dismissWelcome()" class="touch-btn w-full py-3.5 rounded-xl font-extrabold text-base transition
            bg-d-3 text-d-5 cursor-not-allowed">
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- ============================================================= -->
  <!-- MAIN APP (hidden until welcome dismissed)                      -->
  <!-- ============================================================= -->
  <div id="app" class="h-full flex flex-col" style="display:none">

    <!-- HEADER -->
    <header class="bg-d-1 border-b border-d-2 px-4 py-2.5 flex items-center justify-between shrink-0 z-30">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-brand-600 rounded-lg flex items-center justify-center text-white text-lg">üöõ</div>
        <div>
          <h1 class="text-base font-extrabold leading-tight text-d-9">ATI –ú–æ–Ω–∏—Ç–æ—Ä</h1>
          <p class="text-[10px] text-d-5 hidden sm:block">–ì—Ä—É–∑—ã —Å ATI.SU ‚Üí Telegram</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="bot-badge" class="text-[11px] text-d-5 flex items-center gap-1.5"></div>
        <div id="active-badge"
          class="hidden bg-green-950 text-green-400 border border-green-800 rounded-full px-3 py-1 text-[11px] font-bold items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse inline-block"></span>
          <span id="active-count">0</span> –∞–∫—Ç–∏–≤–Ω—ã—Ö
        </div>
      </div>
    </header>

    <!-- BODY -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">

      <!-- LEFT SIDEBAR: Alarms + Bot Users -->
      <aside class="w-full md:w-56 lg:w-60 bg-d-1 border-b md:border-b-0 md:border-r border-d-2 flex flex-col shrink-0">
        <!-- Mobile: horizontal alarm selector with clear labels -->
        <div class="md:hidden px-2 pt-2 pb-1">
          <div class="flex items-center justify-between mb-1">
            <span class="text-[10px] font-bold text-d-5 uppercase tracking-wider">–ë—É–¥–∏–ª—å–Ω–∏–∫–∏</span>
            <span class="text-[10px] text-d-4">‚Üê –ª–∏—Å—Ç–∞–π—Ç–µ ‚Üí</span>
          </div>
          <div id="alarm-list-mobile" class="flex gap-2 overflow-x-auto alarm-scroll pb-1"></div>
        </div>
        <!-- Desktop: vertical alarm list -->
        <div id="alarm-list-desktop" class="hidden md:flex md:flex-col gap-1 p-2 overflow-y-auto md:flex-1"></div>
        <div class="p-2 border-t border-d-2">
          <button onclick="addAlarm()"
            class="touch-btn w-full py-2.5 rounded-lg border-2 border-dashed border-brand-700 text-brand-400 font-bold text-sm hover:bg-brand-950 transition">
            + –ù–æ–≤—ã–π –±—É–¥–∏–ª—å–Ω–∏–∫
          </button>
        </div>
        <!-- Bot users (desktop) -->
        <div id="bot-users-panel" class="hidden md:block border-t border-d-2 p-2">
          <div class="text-[10px] font-bold text-d-5 uppercase tracking-wider px-2 mb-1">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</div>
          <div id="bot-users-list" class="text-[11px] text-d-6 max-h-32 overflow-y-auto"></div>
        </div>
      </aside>

      <!-- CENTER: Editor -->
      <main id="main-area" class="flex-1 overflow-y-auto p-3 md:p-5 bg-d-0">
        <div id="editor" class="max-w-2xl mx-auto pb-20 md:pb-4"></div>
      </main>

      <!-- RIGHT SIDEBAR: Feed (desktop) -->
      <aside id="feed-sidebar" class="hidden md:flex w-72 lg:w-80 bg-d-1 border-l border-d-2 flex-col shrink-0">
        <div class="p-3 border-b border-d-2 flex justify-between items-center">
          <h3 class="font-bold text-sm text-d-6">üì° –õ–µ–Ω—Ç–∞</h3>
          <button onclick="clearFeed()" class="text-[11px] text-d-5 hover:text-red-400 transition">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="feed-desktop" class="flex-1 overflow-y-auto p-2 feed-scroll"></div>
      </aside>
    </div>

    <!-- MOBILE BOTTOM NAV -->
    <nav id="mob-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-d-1 border-t border-d-2 z-50 flex mob-bottom">
      <button onclick="setMobileView('config')" id="mob-tab-config"
        class="flex-1 py-3.5 text-center text-sm font-bold text-brand-400 border-t-2 border-brand-500 transition">
        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      </button>
      <button onclick="setMobileView('feed')" id="mob-tab-feed"
        class="flex-1 py-3.5 text-center text-sm font-bold text-d-5 border-t-2 border-transparent transition">
        üì° –õ–µ–Ω—Ç–∞ <span id="feed-badge"
          class="hidden bg-red-500 text-white text-[10px] rounded-full px-1.5 py-0.5 ml-1 align-middle">0</span>
      </button>
      <button onclick="setMobileView('users')" id="mob-tab-users"
        class="flex-1 py-3.5 text-center text-sm font-bold text-d-5 border-t-2 border-transparent transition">
        üë• –ë–æ—Ç
      </button>
    </nav>

    <!-- MOBILE FEED PANEL -->
    <div id="mob-feed-panel" class="md:hidden fixed inset-0 bg-d-0 z-40 flex flex-col" style="display:none">
      <div class="bg-d-1 border-b border-d-2 p-3 flex justify-between items-center shrink-0">
        <h3 class="font-bold text-sm text-d-7">üì° –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</h3>
        <button onclick="clearFeed()" class="text-[11px] text-d-5">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div id="feed-mobile" class="flex-1 overflow-y-auto p-2 feed-scroll"></div>
      <div class="h-16 shrink-0"></div>
    </div>

    <!-- MOBILE USERS PANEL -->
    <div id="mob-users-panel" class="md:hidden fixed inset-0 bg-d-0 z-40 flex flex-col" style="display:none">
      <div class="bg-d-1 border-b border-d-2 p-3 shrink-0">
        <h3 class="font-bold text-sm text-d-7">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</h3>
        <p class="text-[11px] text-d-5 mt-1">–í—Å–µ –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª /start –±–æ—Ç—É</p>
      </div>
      <div id="bot-users-mobile" class="flex-1 overflow-y-auto p-3"></div>
      <div class="h-16 shrink-0"></div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="fixed bottom-20 md:bottom-4 right-3 z-[60] flex flex-col gap-2"></div>

  <script>
    // =========================================================================
    // STATE
    // =========================================================================
    let alarms = [], activeTab = null, ws = null, feedItems = [], suggestTimeout = null;
    let mobileView = 'config', showAdvanced = false, unreadFeed = 0, botUsersList = [];

    // =========================================================================
    // WELCOME SCREEN
    // =========================================================================
    function checkWelcome() {
      const checked = document.getElementById('welcome-check').checked;
      const btn = document.getElementById('welcome-btn');
      if (checked) {
        btn.disabled = false;
        btn.className = 'touch-btn w-full py-3.5 rounded-xl font-extrabold text-base transition bg-brand-600 text-white hover:bg-brand-700 shadow-lg shadow-brand-900/40 cursor-pointer';
      } else {
        btn.disabled = true;
        btn.className = 'touch-btn w-full py-3.5 rounded-xl font-extrabold text-base transition bg-d-3 text-d-5 cursor-not-allowed';
      }
    }

    function dismissWelcome() {
      document.getElementById('welcome-overlay').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      localStorage.setItem('ati_welcome_done', '1');
      initApp();
    }

    // Check if already accepted
    if (localStorage.getItem('ati_welcome_done') === '1') {
      document.getElementById('welcome-overlay').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
    }

    // =========================================================================
    // API
    // =========================================================================
    const api = {
      get: async u => (await fetch(u)).json(),
      post: async (u, d) => (await fetch(u, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) })).json(),
      put: async (u, d) => (await fetch(u, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) })).json(),
      del: async u => fetch(u, { method: 'DELETE' }),
    };

    const defaultAlarm = () => ({
      name: '–ù–æ–≤—ã–π –±—É–¥–∏–ª—å–Ω–∏–∫', active: false, telegram: '',
      from_location: null, to_location: null,
      weight_min: null, weight_max: null, volume_min: null, volume_max: null,
      date_option: 'today', date_from: null,
      body_types: [], cargo_types: [], loading_types: [],
      payment_options: [], extra_options: [],
      length_min: null, length_max: null, width_min: null, width_max: null,
      height_min: null, height_max: null, pallets: null,
      ellipse_search: false, route_length: false,
      route_length_min: null, route_length_max: null, interval_seconds: 10,
    });

    // =========================================================================
    // VALIDATION
    // =========================================================================
    function hasRoute(a) {
      return (a.from_location && a.from_location.id) || (a.to_location && a.to_location.id);
    }

    // =========================================================================
    // RENDER
    // =========================================================================
    function render() {
      renderAlarmList();
      renderEditor();
      renderActiveBadge();
      renderBotUsers();
    }

    function renderAlarmList() {
      // Mobile: big numbered cards
      const mEl = document.getElementById('alarm-list-mobile');
      if (mEl) {
        mEl.innerHTML = alarms.map((a, i) => `
            <button onclick="selectTab('${a.id}')"
                class="flex-shrink-0 w-36 px-3 py-3 rounded-xl flex flex-col items-start gap-1 transition border-2
                ${a.id === activeTab ? 'bg-brand-950 border-brand-600 ring-1 ring-brand-500' : 'bg-d-2 border-d-3 hover:border-d-4'}
                ${a.active ? 'glow-green' : ''}">
                <div class="flex items-center gap-2 w-full">
                    <span class="w-2.5 h-2.5 rounded-full shrink-0 ${a.active ? 'bg-green-500 animate-pulse' : 'bg-d-4'}"></span>
                    <span class="text-[10px] font-bold text-d-5 uppercase">‚Ññ${i + 1}</span>
                </div>
                <span class="truncate font-bold text-sm text-d-8 w-full text-left">${esc(a.name)}</span>
                ${a.active ? '<span class="text-[10px] text-green-400 font-bold">‚óè –ê–∫—Ç–∏–≤–µ–Ω</span>' : '<span class="text-[10px] text-d-5">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>'}
            </button>
        `).join('');
      }

      // Desktop: vertical list
      const dEl = document.getElementById('alarm-list-desktop');
      if (dEl) {
        dEl.innerHTML = alarms.map((a, i) => `
            <button onclick="selectTab('${a.id}')"
                class="touch-btn w-full text-left px-3 py-2.5 rounded-lg flex items-center gap-2.5 transition
                ${a.id === activeTab ? 'bg-d-2 ring-1 ring-brand-700' : 'hover:bg-d-2'}
                ${a.active ? 'glow-green' : ''}">
                <span class="w-2.5 h-2.5 rounded-full shrink-0 ${a.active ? 'bg-green-500 animate-pulse' : 'bg-d-4'}"></span>
                <span class="text-d-5 text-xs font-bold">${i + 1}.</span>
                <span class="truncate font-semibold text-sm text-d-7">${esc(a.name)}</span>
            </button>
        `).join('');
      }
    }

    function renderActiveBadge() {
      const n = alarms.filter(a => a.active).length;
      const b = document.getElementById('active-badge');
      b.style.display = n > 0 ? 'inline-flex' : 'none';
      document.getElementById('active-count').textContent = n;
    }

    function renderBotUsers() {
      const html = botUsersList.length === 0
        ? '<div class="text-d-5 text-[11px] px-2 py-2">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>'
        : botUsersList.map(u => `
            <div class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-d-2 transition">
                <span class="w-2 h-2 rounded-full bg-green-600 shrink-0"></span>
                <span class="text-d-7 font-semibold">@${esc(u.username)}</span>
                <span class="text-d-5 text-[10px]">${esc(u.first_name)}</span>
            </div>
        `).join('');
      const dEl = document.getElementById('bot-users-list');
      if (dEl) dEl.innerHTML = html;
      const mEl = document.getElementById('bot-users-mobile');
      if (mEl) mEl.innerHTML = `<div class="space-y-1">${html}</div>`;
    }

    function renderEditor() {
      const el = document.getElementById('editor');
      const a = alarms.find(x => x.id === activeTab);
      if (!a) { el.innerHTML = '<div class="text-center text-d-5 py-20 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –±—É–¥–∏–ª—å–Ω–∏–∫</div>'; return; }

      const routeOk = hasRoute(a);
      const routeWarn = !routeOk ? `<div class="bg-amber-950 border border-amber-800 text-amber-300 text-sm rounded-lg p-3 mb-4 font-semibold">‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ—Ä–æ–¥ (–û—Ç–∫—É–¥–∞ –∏–ª–∏ –ö—É–¥–∞) —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</div>` : '';

      el.innerHTML = `
    <div class="bg-d-1 rounded-2xl border border-d-2 overflow-hidden">

        <!-- Top bar -->
        <div class="p-4 border-b border-d-2 flex flex-wrap items-center gap-3">
            <span class="w-3.5 h-3.5 rounded-full shrink-0 ${a.active ? 'bg-green-500 animate-pulse shadow-lg shadow-green-900' : 'bg-d-4'}"></span>
            <input class="flex-1 min-w-0 text-lg font-extrabold bg-transparent outline-none text-d-9 border-b-2 border-transparent focus:border-brand-500 px-1 py-0.5"
                value="${esc(a.name)}" onchange="updateField('name', this.value)" />
            <div class="flex gap-2 flex-wrap">
                <button onclick="testSearch()" ${!routeOk ? 'disabled' : ''} class="touch-btn px-4 py-2.5 rounded-xl text-sm font-bold transition
                    ${routeOk ? 'bg-amber-950 text-amber-400 border border-amber-800 hover:bg-amber-900' : 'bg-d-2 text-d-4 cursor-not-allowed border border-d-3'}">
                    üîç –¢–µ—Å—Ç
                </button>
                ${a.active
          ? `<button onclick="toggleAlarm()" class="touch-btn px-5 py-2.5 rounded-xl bg-red-600 text-white font-bold text-sm hover:bg-red-700 transition shadow-lg shadow-red-900/30">‚èπ –°—Ç–æ–ø</button>`
          : `<button onclick="toggleAlarm()" ${!routeOk ? 'disabled' : ''} class="touch-btn px-5 py-2.5 rounded-xl font-bold text-sm transition shadow-lg
                        ${routeOk ? 'bg-green-600 text-white hover:bg-green-700 shadow-green-900/30' : 'bg-d-2 text-d-4 cursor-not-allowed shadow-none border border-d-3'}">
                        ‚ñ∂ –°—Ç–∞—Ä—Ç</button>`
        }
                <button onclick="deleteCurrentAlarm()" class="touch-btn px-3 py-2.5 rounded-xl bg-d-2 text-red-400 hover:bg-red-950 hover:text-red-300 transition text-sm border border-d-3">‚úï</button>
            </div>
        </div>

        <!-- Telegram -->
        <div class="p-4 border-b border-d-2 flex items-center gap-3 bg-brand-950/20">
            <svg class="w-5 h-5 text-brand-400 shrink-0" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.09l-1.77 8.35c-.13.6-.49.74-.99.46l-2.74-2.02-1.32 1.27c-.15.15-.27.27-.56.27l.2-2.79 5.07-4.58c.22-.2-.05-.3-.34-.12l-6.27 3.95-2.7-.84c-.59-.18-.6-.59.12-.87l10.56-4.07c.49-.18.91.12.74.99z"/>
            </svg>
            <span class="text-d-5 text-base font-bold">@</span>
            <input class="flex-1 min-w-0 bg-d-2 border border-d-3 rounded-lg px-3 py-2.5 text-sm font-medium outline-none text-d-8 focus:border-brand-500 focus:ring-1 focus:ring-brand-800 transition placeholder-d-4"
                placeholder="–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram" value="${esc(a.telegram)}"
                onchange="updateField('telegram', this.value.replace('@',''))" />
        </div>

        <!-- SIMPLE FILTERS -->
        <div class="p-4 space-y-4">
            ${routeWarn}

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider">üìç –ú–∞—Ä—à—Ä—É—Ç</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                ${cityField('from_location', '–û—Ç–∫—É–¥–∞ (–≥–æ—Ä–æ–¥)', a.from_location)}
                ${cityField('to_location', '–ö—É–¥–∞ (–≥–æ—Ä–æ–¥, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)', a.to_location)}
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">üìÖ –î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
            <div class="flex gap-2 flex-wrap">
                ${[['today', 'üìÖ –°–µ–≥–æ–¥–Ω—è'], ['tomorrow', 'üìÖ –ó–∞–≤—Ç—Ä–∞'], ['manual', 'üìÖ –í—ã–±—Ä–∞—Ç—å']].map(([v, l]) =>
          `<button onclick="updateField('date_option','${v}')"
                        class="touch-btn px-4 py-2.5 rounded-lg text-sm font-bold transition border
                        ${a.date_option === v ? 'pill-on' : 'bg-d-2 border-d-3 text-d-6 hover:border-brand-700'}">${l}</button>`
        ).join('')}
            </div>
            ${a.date_option === 'manual' ? `
                <input type="date" class="bg-d-2 border border-d-3 rounded-lg px-3 py-2.5 text-sm text-d-8 outline-none focus:border-brand-500 w-44"
                    value="${a.date_from || ''}" onchange="updateField('date_from', this.value)" />
            ` : ''}

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">‚öñÔ∏è –í–µ—Å –∏ –æ–±—ä—ë–º</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                ${minmax('–í–µ—Å', '—Ç', a.weight_min, a.weight_max, 'weight_min', 'weight_max')}
                ${minmax('–û–±—ä—ë–º', '–º¬≥', a.volume_min, a.volume_max, 'volume_min', 'volume_max')}
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">üöõ –¢–∏–ø –∫—É–∑–æ–≤–∞</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                ${cbs([
          { v: '1', l: 'üèï –¢–µ–Ω—Ç' }, { v: '4', l: '‚ùÑÔ∏è –†–µ—Ñ—Ä–∏–∂–µ—Ä–∞—Ç–æ—Ä' },
          { v: '91', l: 'üì¶ –ó–∞–∫—Ä—ã—Ç—ã–π + –∏–∑–æ—Ç–µ—Ä–º' }, { v: '844424930131980', l: 'üßä –†–µ—Ñ. + –∏–∑–æ—Ç–µ—Ä–º' },
          { v: '70368744191104', l: 'üîì –í—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ' }, { v: '844424930132059', l: 'üîí –ó–∞–∫—Ä—ã—Ç—ã–π + —Ç–µ—Ä–º–æ—Å' },
        ], 'body_types', a.body_types)}
            </div>
        </div>

        <!-- ADVANCED TOGGLE -->
        <div class="border-t border-d-2">
            <button onclick="showAdvanced=!showAdvanced; render()"
                class="w-full px-4 py-3.5 text-sm font-bold text-brand-400 hover:bg-brand-950/30 transition flex items-center justify-center gap-2">
                ${showAdvanced ? '‚ñ≤ –°–∫—Ä—ã—Ç—å –¥–æ–ø. —Ñ–∏–ª—å—Ç—Ä—ã' : '‚ñº –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–ø. —Ñ–∏–ª—å—Ç—Ä—ã'}
            </button>
        </div>

        ${showAdvanced ? `
        <div class="p-4 space-y-4 bg-d-0/30 border-t border-d-2">
            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider">üì¶ –¢–∏–ø –≥—Ä—É–∑–∞</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                ${cbs([
          { v: '80', l: '–î–æ—Å–∫–∞' }, { v: '42', l: '–°—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã' },
          { v: '46', l: '–¢–ù–ü' }, { v: '34', l: '–ü—Ä–æ–¥—É–∫—Ç—ã' },
          { v: '87', l: '–í–∞–≥–æ–Ω–∫–∞' }, { v: '35', l: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },
          { v: '36', l: '–ú–µ–±–µ–ª—å' }, { v: '37', l: '–ú–µ—Ç–∞–ª–ª' }, { v: '38', l: '–¢–∞—Ä–∞' },
        ], 'cargo_types', a.cargo_types)}
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">üèó –¢–∏–ø –∑–∞–≥—Ä—É–∑–∫–∏</div>
            <div class="grid grid-cols-2 gap-2">
                ${cbs([
          { v: '1', l: '‚¨ÜÔ∏è –í–µ—Ä—Ö–Ω—è—è' }, { v: '4', l: '‚¨ÖÔ∏è –ó–∞–¥–Ω—è—è' },
          { v: '8', l: 'üì• –ü–æ–ª–Ω–∞—è' }, { v: '65536', l: '‚ùì –ù–µ —É–∫–∞–∑–∞–Ω–æ' },
        ], 'loading_types', a.loading_types)}
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">üí≥ –û–ø–ª–∞—Ç–∞</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                ${cbs([
          { v: '1', l: 'üíµ –°—Ç–∞–≤–∫–∞' }, { v: '2', l: 'üí≥ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' },
          { v: '8', l: 'üí∞ –ù–∞–ª–∏—á–Ω—ã–µ' }, { v: '512', l: 'üö´ –ë–µ–∑ —Å—Ç–∞–≤–∫–∏' },
          { v: '1024', l: '‚úÖ –° –ù–î–°' }, { v: '2048', l: '‚ùå –ë–µ–∑ –ù–î–°' },
        ], 'payment_options', a.payment_options)}
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">üìê –ì–∞–±–∞—Ä–∏—Ç—ã</div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                ${minmax('–î–ª–∏–Ω–∞', '–º', a.length_min, a.length_max, 'length_min', 'length_max')}
                ${minmax('–®–∏—Ä–∏–Ω–∞', '–º', a.width_min, a.width_max, 'width_min', 'width_max')}
                ${minmax('–í—ã—Å–æ—Ç–∞', '–º', a.height_min, a.height_max, 'height_min', 'height_max')}
            </div>
            <div class="mt-2">
                <label class="text-[11px] font-bold text-d-5 uppercase tracking-wider block mb-1">–ü–∞–ª–µ—Ç—ã</label>
                <input type="number" class="bg-d-2 border border-d-3 rounded-lg px-3 py-2.5 text-sm text-d-8 w-28 outline-none focus:border-brand-500 placeholder-d-4"
                    placeholder="–∫–æ–ª-–≤–æ" value="${a.pallets || ''}"
                    onchange="updateField('pallets', this.value?parseInt(this.value):null)" />
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">‚öôÔ∏è –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                ${cbs([
          { v: '4', l: 'üîÑ –û–±—Ä–∞—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞' },
          { v: '128', l: 'üö´ –ë–µ–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö' },
          { v: '256', l: 'üìè –ö–æ–Ω–∏–∫–∏' },
          { v: 'excludeTenders', l: 'üö´ –ë–µ–∑ —Ç–µ–Ω–¥–µ—Ä–æ–≤' },
          { v: 'teamDriving', l: 'üë• –°–∫—Ä—ã—Ç—å —ç–∫–∏–ø–∞–∂ (2 –≤–æ–¥–∏—Ç.)' },
          { v: 'withAdr', l: '‚ò¢Ô∏è –ê–î–† (–æ–ø–∞—Å–Ω—ã–µ –≥—Ä—É–∑—ã)' },
        ], 'extra_options', a.extra_options)}
            </div>

            <div class="text-[11px] font-bold text-d-5 uppercase tracking-wider pt-2">‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="flex items-center gap-4">
                <input type="range" min="5" max="120" value="${a.interval_seconds}" class="flex-1 h-2"
                    oninput="document.getElementById('iv').textContent=this.value+'—Å'"
                    onchange="updateField('interval_seconds', parseInt(this.value))" />
                <span id="iv" class="text-lg font-extrabold text-brand-400 w-12 text-right">${a.interval_seconds}—Å</span>
            </div>
            <p class="text-[11px] text-d-5">–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å ATI.SU (5‚Äì120 —Å–µ–∫)</p>
        </div>
        ` : ''}
    </div>`;
    }

    // =========================================================================
    // TEMPLATE HELPERS
    // =========================================================================
    function cityField(field, ph, value) {
      const disp = value ? (value.address || value.name || '') : '';
      return `
    <div class="relative" id="city-${field}">
        <input class="w-full bg-d-2 border border-d-3 rounded-lg px-3 py-2.5 text-sm font-medium outline-none text-d-8 focus:border-brand-500 focus:ring-1 focus:ring-brand-800 transition placeholder-d-4 pr-8"
            placeholder="${ph}" value="${esc(disp)}"
            oninput="handleSuggest('${field}', this.value)"
            onfocus="handleSuggest('${field}', this.value)" />
        ${value ? `<button onclick="event.stopPropagation(); updateField('${field}', null)" class="absolute right-2 top-1/2 -translate-y-1/2 text-d-5 hover:text-red-400 text-lg leading-none">√ó</button>` : ''}
        <div id="dd-${field}" class="hidden absolute top-full left-0 right-0 mt-1 bg-d-1 border border-d-3 rounded-lg z-50 max-h-52 overflow-y-auto dd-shadow"></div>
    </div>`;
    }

    function minmax(label, unit, lo, hi, loF, hiF) {
      return `
    <div>
        <label class="text-[11px] font-bold text-d-5 block mb-1">${label} (${unit})</label>
        <div class="flex items-center gap-2">
            <input type="number" class="flex-1 min-w-0 bg-d-2 border border-d-3 rounded-lg px-3 py-2.5 text-sm text-d-8 outline-none focus:border-brand-500 placeholder-d-4"
                placeholder="–æ—Ç" value="${lo ?? ''}"
                onchange="updateField('${loF}', this.value?parseFloat(this.value):null)" />
            <span class="text-d-5 font-bold">‚Äî</span>
            <input type="number" class="flex-1 min-w-0 bg-d-2 border border-d-3 rounded-lg px-3 py-2.5 text-sm text-d-8 outline-none focus:border-brand-500 placeholder-d-4"
                placeholder="–¥–æ" value="${hi ?? ''}"
                onchange="updateField('${hiF}', this.value?parseFloat(this.value):null)" />
        </div>
    </div>`;
    }

    function cbs(opts, field, sel) {
      return opts.map(o => `
        <label class="flex items-center gap-3 p-2.5 rounded-lg border transition cursor-pointer select-none
            ${sel.includes(o.v) ? 'bg-brand-950 border-brand-700 text-brand-200' : 'bg-d-2 border-d-3 text-d-6 hover:border-d-4'}">
            <input type="checkbox" class="big-check rounded" ${sel.includes(o.v) ? 'checked' : ''}
                onchange="toggleArr('${field}','${o.v}',this.checked)" />
            <span class="text-sm font-semibold">${o.l}</span>
        </label>
    `).join('');
    }

    // =========================================================================
    // CITY AUTOCOMPLETE
    // =========================================================================
    function handleSuggest(field, val) {
      clearTimeout(suggestTimeout);
      const dd = document.getElementById(`dd-${field}`);
      if (val.length < 2) { dd.classList.add('hidden'); return; }
      suggestTimeout = setTimeout(async () => {
        try {
          const data = await api.post('/api/suggest', { prefix: val });
          const sugs = data.suggestions || [];
          if (!sugs.length) { dd.classList.add('hidden'); return; }
          dd.innerHTML = sugs.map((s, i) => {
            const nm = s.city?.name || s.region?.name || '';
            const ad = s.address || '';
            return `<div onclick="pickCity('${field}',${i})" class="px-3 py-2.5 cursor-pointer hover:bg-d-2 transition border-b border-d-2 last:border-0">
                    <div class="font-bold text-sm text-d-8">${esc(nm)}</div>
                    <div class="text-[11px] text-d-5">${esc(ad)}</div>
                </div>`;
          }).join('');
          dd.classList.remove('hidden');
          dd._sugs = sugs;
        } catch (e) { console.error(e); }
      }, 300);
    }

    function pickCity(field, idx) {
      const dd = document.getElementById(`dd-${field}`);
      const s = dd._sugs[idx];
      const sugType = s.type;
      let id, name;
      if (sugType === 1 && s.city) { id = s.city.id; name = s.city.name; }
      else { id = s.region?.id; name = s.region?.name; }
      const searchType = sugType === 1 ? 2 : 1;
      updateField(field, { id, type: searchType, name, address: s.address || name });
      dd.classList.add('hidden');
    }

    document.addEventListener('click', e => {
      if (!e.target.closest('[id^="city-"]'))
        document.querySelectorAll('[id^="dd-"]').forEach(d => d.classList.add('hidden'));
    });

    // =========================================================================
    // ACTIONS
    // =========================================================================
    function selectTab(id) { activeTab = id; render(); }

    async function addAlarm() {
      const res = await api.post('/api/alarms', defaultAlarm());
      alarms.push(res.alarm);
      activeTab = res.alarm.id;
      render();
    }

    async function deleteCurrentAlarm() {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±—É–¥–∏–ª—å–Ω–∏–∫?')) return;
      await api.del(`/api/alarms/${activeTab}`);
      alarms = alarms.filter(a => a.id !== activeTab);
      activeTab = alarms[0]?.id || null;
      render();
    }

    async function toggleAlarm() {
      const a = alarms.find(x => x.id === activeTab);
      if (!a) return;
      if (a.active) {
        await api.post(`/api/alarms/${a.id}/stop`);
        a.active = false;
        toast('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'red');
      } else {
        if (!hasRoute(a)) { toast('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ—Ä–æ–¥!', 'amber'); return; }
        if (!a.telegram) { toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram!', 'amber'); return; }
        a.active = true;
        await api.put(`/api/alarms/${a.id}`, a);
        toast('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!', 'green');
      }
      render();
    }

    function updateField(field, value) {
      const a = alarms.find(x => x.id === activeTab);
      if (!a) return;
      a[field] = value;
      clearTimeout(a._st);
      a._st = setTimeout(() => api.put(`/api/alarms/${a.id}`, a), 500);
      render();
    }

    function toggleArr(field, val, checked) {
      const a = alarms.find(x => x.id === activeTab);
      if (!a) return;
      if (checked) { if (!a[field].includes(val)) a[field].push(val); }
      else { a[field] = a[field].filter(v => v !== val); }
      clearTimeout(a._st);
      a._st = setTimeout(() => api.put(`/api/alarms/${a.id}`, a), 500);
      render();
    }

    async function testSearch() {
      const a = alarms.find(x => x.id === activeTab);
      if (!a || !hasRoute(a)) { toast('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ—Ä–æ–¥!', 'amber'); return; }
      addFeed('status', '–¢–µ—Å—Ç', 'üîç –ü–æ–∏—Å–∫...');
      try {
        const r = await api.post('/api/test-search', a);
        const cnt = r.loads?.length || 0;
        addFeed('status', '–¢–µ—Å—Ç', `–ù–∞–π–¥–µ–Ω–æ ${cnt} –≥—Ä—É–∑–æ–≤`);
        for (const ld of (r.loads || [])) addFeed('load', a.name, ld.message);
        toast(`–ù–∞–π–¥–µ–Ω–æ ${cnt} –≥—Ä—É–∑–æ–≤`, 'brand');
      } catch (e) {
        addFeed('error', '–¢–µ—Å—Ç', e.message);
        toast('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'red');
      }
    }

    // =========================================================================
    // FEED
    // =========================================================================
    function addFeed(type, name, msg) {
      feedItems.unshift({ type, name, msg, time: new Date().toLocaleTimeString('ru-RU') });
      if (feedItems.length > 100) feedItems.length = 100;
      if (mobileView !== 'feed') unreadFeed++;
      renderFeed();
    }

    function clearFeed() { feedItems = []; unreadFeed = 0; renderFeed(); }

    function renderFeed() {
      const html = feedItems.length === 0
        ? '<div class="text-center text-d-5 py-10 text-sm">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.</div>'
        : feedItems.map(f => {
          const cls = { load: 'border-l-[3px] border-brand-500 bg-brand-950/30', error: 'border-l-[3px] border-red-500 bg-red-950/30', status: 'bg-d-2/50' };
          return `<div class="p-2.5 rounded-lg mb-1.5 text-xs ${cls[f.type] || ''}">
                <span class="text-d-5">${f.time}</span>
                <span class="ml-1.5 bg-brand-900 text-brand-300 px-1.5 py-0.5 rounded text-[10px] font-bold">${esc(f.name)}</span>
                <div class="mt-1 leading-relaxed text-[13px] text-d-7">${f.msg}</div>
            </div>`;
        }).join('');
      const dEl = document.getElementById('feed-desktop');
      const mEl = document.getElementById('feed-mobile');
      if (dEl) dEl.innerHTML = html;
      if (mEl) mEl.innerHTML = html;
      const badge = document.getElementById('feed-badge');
      if (badge) {
        if (unreadFeed > 0) { badge.classList.remove('hidden'); badge.textContent = unreadFeed; }
        else badge.classList.add('hidden');
      }
    }

    // =========================================================================
    // MOBILE VIEW SWITCHING
    // =========================================================================
    function setMobileView(v) {
      mobileView = v;
      document.getElementById('main-area').style.display = 'none';
      document.getElementById('mob-feed-panel').style.display = 'none';
      document.getElementById('mob-users-panel').style.display = 'none';

      if (v === 'config') document.getElementById('main-area').style.display = '';
      else if (v === 'feed') document.getElementById('mob-feed-panel').style.display = 'flex';
      else if (v === 'users') document.getElementById('mob-users-panel').style.display = 'flex';

      ['config', 'feed', 'users'].forEach(t => {
        const btn = document.getElementById(`mob-tab-${t}`);
        if (!btn) return;
        btn.className = t === v
          ? 'flex-1 py-3.5 text-center text-sm font-bold text-brand-400 border-t-2 border-brand-500 transition'
          : 'flex-1 py-3.5 text-center text-sm font-bold text-d-5 border-t-2 border-transparent transition';
      });

      if (v === 'feed') { unreadFeed = 0; renderFeed(); }
    }

    // =========================================================================
    // TOAST
    // =========================================================================
    function toast(msg, color = 'brand') {
      const el = document.getElementById('toasts');
      const c = { brand: 'bg-brand-600 text-white', green: 'bg-green-600 text-white', red: 'bg-red-600 text-white', amber: 'bg-amber-600 text-white' };
      const d = document.createElement('div');
      d.className = `toast-anim px-4 py-2.5 rounded-lg font-bold text-sm shadow-xl ${c[color] || c.brand}`;
      d.textContent = msg;
      el.appendChild(d);
      setTimeout(() => d.remove(), 3000);
    }

    // =========================================================================
    // WEBSOCKET
    // =========================================================================
    function connectWS() {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${proto}://${location.host}/ws`);
      ws.onmessage = e => {
        try {
          const d = JSON.parse(e.data);
          if (d.type === 'new_load') addFeed('load', d.alarm_name || '?', d.message);
          else if (d.type === 'status') addFeed('status', alarms.find(a => a.id === d.alarm_id)?.name || '?',
            `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${d.new_count} –Ω–æ–≤—ã—Ö (–≤—Å–µ–≥–æ ${d.known_count})`);
          else if (d.type === 'error') addFeed('error', alarms.find(a => a.id === d.alarm_id)?.name || '?', d.message);
        } catch (err) { }
      };
      ws.onclose = () => setTimeout(connectWS, 3000);
      setInterval(() => { if (ws && ws.readyState === WebSocket.OPEN) ws.send('ping'); }, 30000);
    }

    // =========================================================================
    // UTILS
    // =========================================================================
    function esc(s) { return s ? String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') : ''; }

    // =========================================================================
    // INIT
    // =========================================================================
    async function initApp() {
      try {
        const bs = await api.get('/api/bot-status');
        const el = document.getElementById('bot-badge');
        el.innerHTML = bs.configured
          ? `<span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> @${bs.bot_username}`
          : `<span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> –ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω`;
      } catch (e) { }

      try { botUsersList = (await api.get('/api/bot-users')).users || []; } catch (e) { }

      try { alarms = (await api.get('/api/alarms')).alarms || []; } catch (e) { }
      if (alarms.length === 0) {
        const r = await api.post('/api/alarms', defaultAlarm());
        alarms.push(r.alarm);
      }
      activeTab = alarms[0].id;
      render();
      connectWS();

      setInterval(async () => {
        try {
          botUsersList = (await api.get('/api/bot-users')).users || [];
          renderBotUsers();
        } catch (e) { }
      }, 30000);
    }

    // Auto-init if welcome already dismissed
    if (localStorage.getItem('ati_welcome_done') === '1') {
      initApp();
    }
  </script>
</body>

</html>